# Theory Master Plan: Microtonality & Tuning Systems

## 1. Introduction
This document establishes the theoretical foundation for the DNDPLHLS project's microtonal expansion. It covers the mathematical frameworks for Regular Temperament Theory, Fokker Periodicity Blocks, Just Intonation Lattices, Spectral Microtonality (Sethares), and Historical Non-Western Tuning Systems.

## 2. Regular Temperament Theory

### 2.1. Mathematical Framework
Regular temperament represents musical intervals as vectors in a multidimensional prime space.
*   **Prime Space (J):** A vector $v = [v_2, v_3, v_5, \dots]$ represents the interval $2^{v_2} \cdot 3^{v_3} \cdot 5^{v_5} \dots$.
*   **Mapping Matrix (M):** A transformation that maps prime intervals to a set of generators (e.g., octaves and fifths).
    $$ G = M \cdot p $$
    Where $p$ is the prime interval vector and $G$ is the generator vector.
*   **Val (Valuation):** A vector representing how many steps of the temperament map to each prime.

### 2.2. Comma Pumps
A comma pump is a sequence of intervals that mathematically returns to the starting pitch but, due to the temperament, arrives at a pitch shifted by a "comma" (a small interval tempered out in the system).
*   **Definition:** A cycle in the lattice of intervals that sums to a non-zero vector in prime space but maps to zero in the tempered space.
*   **Application:** In dynamic tuning, comma pumps can cause pitch drift. The engine must track this drift or use "comma traps" to reset pitch.

### 2.3. Matrices
Standard Regular Temperaments can be defined by their mapping matrices.
*   **Meantone (Rank 2):** Maps primes [2, 3, 5] to [Octave, Generator].
    *   Example (1/4-comma): Generator $\approx 696.6$ cents.
*   **Porcupine, Hanson, Magic:** Other rank-2 temperaments defined by different comma vanishing behaviors.

## 3. Fokker Periodicity Blocks & ADPF

### 3.1. Concept
A Fokker periodicity block is a geometric representation of a finite selection of pitches from a Just Intonation lattice that forms a "valid" scale or gamut.
*   **Unison Vectors (Commas):** A set of intervals $U = \{u_1, u_2, \dots\}$ that are treated as unison (0 steps).
*   **Lattice Quotient:** The block is the fundamental domain of the quotient group $L / U$, where $L$ is the full JI lattice.

### 3.2. Construction Algorithm
1.  **Define Unison Vectors:** Choose a set of commas (e.g., Syntonic Comma 81/80, Diesis 128/125).
2.  **Form Matrix:** Construct a matrix where rows are the prime factorizations of the unison vectors.
3.  **Hermite Normal Form (HNF):** Compute the HNF to find the basis of the sublattice.
4.  **Identify Points:** The points inside the parallelotope defined by the basis vectors form the periodicity block.
5.  **ADPF:** Refers to the specific projection methods used by Fokker to visualize these high-dimensional blocks in 2D or 3D.

## 4. Just Intonation (JI) Lattices

### 4.1. 5-Limit to 23-Limit
*   **5-Limit:** Lattice generated by primes 2, 3, 5. Structure is often visualized as a 2D hexagonal grid (ignoring octaves).
*   **7-Limit:** Adds prime 7 (harmonic seventh). 3D structure.
*   **Higher Limits (11, 13, ..., 23):** Higher dimensional lattices.
    *   **Representation:** Vectors in $\mathbb{Z}^n$ where $n$ is the number of primes (Prime Limit).
    *   **Distance Metric:** To navigate the lattice, we use metrics like **Tenney Height** ($H(n/d) = \log_2(n \cdot d)$) or **Benedict height** to find "simple" ratios.

### 4.2. Lattice Traversal
The "Coder" will implement algorithms to traverse this lattice:
*   `getNeighbors(ratio)`: Returns ratios connected by prime steps (e.g., $\times 3, \times 5, \times 7$).
*   `findClosest(cents)`: Search the lattice for the JI ratio closest to a given cent value.

## 5. Spectral Microtonality (Sethares)

### 5.1. Dissonance Curves
William Sethares' algorithm calculates the "sensory dissonance" of an interval based on the interference of partials.
*   **Input:** Spectrum of a timbre (frequencies $f_i$ and amplitudes $a_i$).
*   **Pairwise Dissonance:** $d(f_1, f_2, a_1, a_2) = a_1 a_2 [e^{-b x} - e^{-c x}]$, where $x$ is the difference in critical bandwidth.
*   **Total Dissonance:** Sum of all pairwise dissonances.
*   **Curve:** Plotting Total Dissonance against the interval ratio (frequency ratio $\alpha$).

### 5.2. Adaptive Tuning
*   **Minima:** Local minima in the dissonance curve correspond to the most consonant intervals for that specific timbre.
*   **Application:** The engine can dynamically adjust the tuning scale based on the instrument's timbre to maximize consonance (or control dissonance).

## 6. Historical Non-Western Tuning Systems

### 6.1. Analysis of .scl Files
The project includes a massive library of Scala (.scl) files.
*   **Maqam (Middle Eastern):** Often based on 24-TET or specific JI ratios (e.g., neutral thirds). Examples: `bayati.scl`, `rast.scl`.
*   **Raga (Indian):** Based on Srutis (22 subdivisions). Just Intonation based. Examples: `young.scl` (well-temperament, but relevant context), `indian.scl`.
*   **Gamelan (Indonesian):** Pelog (7-tone) and Slendro (5-tone). Inharmonic spectra match the tuning. Examples: `slendro.scl`, `pelog.scl`.

### 6.2. Implementation Strategy
*   **Parser:** A robust parser to read `.scl` files (handling cents and ratios).
*   **Mapping:** Map these static scales to the dynamic synth engine.
*   **Context:** Use metadata to suggest appropriate timbres (e.g., Gamelan tuning for bell-like spectra).

## 7. Conclusion
This master plan provides the mathematical and theoretical backbone for the DNDPLHLS microtonal engine. The next steps are to implement the algorithms specified in `ALGORITHM_SPECS.md` and populate the data structures in `src/data/theory_constants.ts`.
