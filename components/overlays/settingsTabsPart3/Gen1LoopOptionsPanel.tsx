import React from 'react';
import type { PrimeLimit } from '../../../types';

type Gen1LoopOptionsPanelProps = {
    settings: any;
    globalSettings: any;
    allLimits: PrimeLimit[];
    isGen1Custom: boolean;
    gen1Collapsed: boolean;
    setGen1Collapsed: React.Dispatch<React.SetStateAction<boolean>>;
    targetGen0: PrimeLimit;
    setTargetGen0: React.Dispatch<React.SetStateAction<PrimeLimit>>;
    openLoopFinder: { limit: PrimeLimit; gen: 0 | 1 | 2; parentLimit?: PrimeLimit } | null;
    setOpenLoopFinder: React.Dispatch<React.SetStateAction<{ limit: PrimeLimit; gen: 0 | 1 | 2; parentLimit?: PrimeLimit } | null>>;
    loopOrder: "size" | "position";
    setLoopOrder: React.Dispatch<React.SetStateAction<"size" | "position">>;
    handleSettingChange: (...args: any[]) => void;
    findLoops: (limit: PrimeLimit) => { length: number; diff: number }[];
    sortLoops: (candidates: { length: number; diff: number }[]) => { length: number; diff: number }[];
    toggleAxisLoop: (limit: PrimeLimit) => void;
    onInteractionStart: () => void;
    onInteractionEnd: () => void;
};

export const Gen1LoopOptionsPanel: React.FC<Gen1LoopOptionsPanelProps> = ({
    settings,
    globalSettings,
    allLimits,
    isGen1Custom,
    gen1Collapsed,
    setGen1Collapsed,
    targetGen0,
    setTargetGen0,
    openLoopFinder,
    setOpenLoopFinder,
    loopOrder,
    setLoopOrder,
    handleSettingChange,
    findLoops,
    sortLoops,
    toggleAxisLoop,
    onInteractionStart,
    onInteractionEnd
}) => { const gen1Limit = Math.min(settings.maxPrimeLimit, settings.gen1MaxPrimeLimit ?? settings.maxPrimeLimit) as PrimeLimit; const activePrimes = allLimits.filter(p => p <= gen1Limit); return (<div className="mt-3 p-2 bg-gray-900 border border-gray-700 rounded">                <div className="flex justify-between items-center mb-2">                    <label className="flex items-center gap-2 cursor-pointer bg-gray-800/50 hover:bg-gray-800 px-2 py-1 rounded transition-colors w-full">                        <input type="checkbox" checked={isGen1Custom} onChange={(e) => { if (e.target.checked) {
    const init: any = {};
    allLimits.forEach(p => init[p] = settings.expansionB);
    handleSettingChange({ gen1Lengths: init }, undefined, true);
}
else {
    handleSettingChange({ gen1Lengths: {}, gen1Ranges: {}, gen2Lengths: {}, gen2Ranges: {} }, undefined, true);
} }} className="w-3 h-3 accent-green-500"/>                        <span className="text-[10px] font-bold text-green-400 uppercase">Customize Gen 1 Branches</span>                    </label>                    {isGen1Custom && (<button onClick={() => setGen1Collapsed(!gen1Collapsed)} className="text-[10px] text-blue-400 hover:text-white ml-2">                            {gen1Collapsed ? 'Show' : 'Hide'}                        </button>)}                </div>                {isGen1Custom && !gen1Collapsed && (<div className="space-y-4 animate-in fade-in slide-in-from-top-1">                        <div className="flex items-center gap-2 mb-2 bg-black/40 p-2 rounded border border-gray-800">                            <span className="text-[9px] text-gray-400 font-bold uppercase">Target Gen 0 Axis:</span>                            <div className="flex gap-1 flex-wrap">                                {settings.rootLimits?.map((r: PrimeLimit) => (<button key={r} onClick={() => setTargetGen0(r)} className={`px-2 py-1 text-[9px] font-bold rounded border transition-colors ${targetGen0 === r ? 'bg-blue-600 border-blue-500 text-white' : 'bg-gray-800 border-gray-700 text-gray-500 hover:bg-gray-700'}`}>                                        {r}L                                    </button>))}                            </div>                        </div>                        {activePrimes.map((l: any) => { const limit = l as PrimeLimit; const isLooped = settings.axisLooping && settings.axisLooping[limit] !== null; const currentNeg = settings.gen1Ranges?.[limit]?.neg ?? (settings.gen1Lengths?.[limit] ?? settings.expansionB); const currentPos = settings.gen1Ranges?.[limit]?.pos ?? (settings.gen1Lengths?.[limit] ?? settings.expansionB); const isParallel = limit === targetGen0; const hasGen2Custom = settings.gen2Lengths && settings.gen2Lengths[limit] !== undefined; return (<div key={limit} className={`flex flex-col bg-gray-800/50 p-2 rounded gap-2 ${isParallel ? 'opacity-40 pointer-events-none grayscale' : ''}`}>                                    <div className="flex justify-between items-center border-b border-gray-700 pb-1 mb-1">                                        <span className="text-xs font-bold text-green-300">{limit}-Limit Branches</span>                                        {isParallel ? (<span className="text-[9px] text-yellow-500 font-bold uppercase">Parallel (Disabled)</span>) : (<button onClick={() => setOpenLoopFinder(openLoopFinder?.limit === limit && openLoopFinder.gen === 1 ? null : { limit, gen: 1 })} className="text-[9px] bg-green-900/50 hover:bg-green-800 text-green-200 px-2 py-0.5 rounded border border-green-700"> {(openLoopFinder?.limit === limit && openLoopFinder.gen === 1) ? 'Close Finder' : 'Find Loops'} </button>)}                                    </div>                                    {(openLoopFinder?.limit === limit && openLoopFinder.gen === 1) && (<div className="mb-2 bg-black/50 p-2 rounded border border-gray-600">                                            <div className="flex items-center justify-between mb-2">                                                <span className="text-[9px] text-gray-400">Select a loop for Gen 1:</span>                                                <label className="flex items-center gap-1 text-[9px] text-gray-500">                                                    Order                                                    <select value={loopOrder} onChange={(e) => setLoopOrder(e.target.value as 'size' | 'position')} className="bg-gray-900 border border-gray-700 rounded text-[9px] text-gray-200 px-1 py-0.5">                                                        <option value="position">Position (c err)</option>                                                        <option value="size">Size</option>                                                    </select>                                                </label>                                            </div>                                            <div className="flex flex-col gap-1 max-h-[144px] overflow-y-auto custom-scrollbar pr-1">                                                {sortLoops(findLoops(limit)).map((cand, idx) => (<div key={idx} className="flex items-center justify-between bg-gray-900 px-2 py-1 rounded">                                                        <span className="text-[10px] font-mono text-white">Size {cand.length} <span className="text-gray-500">({cand.diff.toFixed(1)}c)</span></span>                                                        <button onClick={() => { const neg = Math.floor(cand.length / 2); const pos = Math.ceil(cand.length / 2); const newRanges = { ...(settings.gen1Ranges || {}), [limit]: { neg, pos } }; handleSettingChange('gen1Ranges', newRanges); const next = cand.length / 2; const newLooping = { ...(settings.axisLooping || {}), [limit]: next }; handleSettingChange('axisLooping', newLooping); }} className="text-[9px] bg-gray-700 hover:bg-white hover:text-black px-1 rounded border border-gray-500"> Sym </button>                                                    </div>))}                                            </div>                                        </div>)}                                    <div className="grid grid-cols-2 gap-2">                                        <div className="flex flex-col gap-1">                                            <div className="flex justify-between items-center">                                                <span className="text-[9px] text-gray-500 uppercase">Negative</span>                                                <input type="number" min="0" max="60" value={currentNeg} onChange={(e) => { const val = Math.max(0, parseInt(e.target.value) || 0); const newRanges = { ...(settings.gen1Ranges || {}), [limit]: { neg: val, pos: currentPos } }; handleSettingChange('gen1Ranges', newRanges, false); }} className="w-10 bg-black/50 border border-gray-700 rounded text-[9px] text-green-300 text-center outline-none"/>                                            </div>                                            <input type="range" min="0" max="60" value={currentNeg} onPointerDown={onInteractionStart} onPointerUp={onInteractionEnd} onChange={(e) => { const val = parseInt(e.target.value); const newRanges = { ...(settings.gen1Ranges || {}), [limit]: { neg: val, pos: currentPos } }; handleSettingChange('gen1Ranges', newRanges, false); }} className="w-full h-1 accent-green-500"/>                                        </div>                                        <div className="flex flex-col gap-1">                                            <div className="flex justify-between items-center">                                                <span className="text-[9px] text-gray-500 uppercase">Positive</span>                                                <input type="number" min="0" max="60" value={currentPos} onChange={(e) => { const val = Math.max(0, parseInt(e.target.value) || 0); const newRanges = { ...(settings.gen1Ranges || {}), [limit]: { neg: currentNeg, pos: val } }; handleSettingChange('gen1Ranges', newRanges, false); }} className="w-10 bg-black/50 border border-gray-700 rounded text-[9px] text-green-300 text-center outline-none"/>                                            </div>                                            <input type="range" min="0" max="60" value={currentPos} onPointerDown={onInteractionStart} onPointerUp={onInteractionEnd} onChange={(e) => { const val = parseInt(e.target.value); const newRanges = { ...(settings.gen1Ranges || {}), [limit]: { neg: currentNeg, pos: val } }; handleSettingChange('gen1Ranges', newRanges, false); }} className="w-full h-1 accent-green-500"/>                                        </div>                                    </div>                                    <div className="flex justify-between items-center mt-1">                                        {isLooped ? <span className="text-[9px] text-green-400">Ring Visual Enabled</span> : <span className="text-[9px] text-gray-500">Total Length: {currentNeg + currentPos}</span>}                                        <button onClick={() => toggleAxisLoop(limit)} className={`px-2 py-0.5 rounded text-[9px] border ${isLooped ? 'bg-green-900/50 border-green-500 text-green-200' : 'bg-gray-700 border-gray-600 text-gray-500 hover:bg-gray-600'}`}>{isLooped ? 'Disable Ring' : 'Enable Ring Visual'}</button>                                    </div>                                                                        <div className="mt-2 pt-2 border-t border-gray-700">                                        <label className="flex items-center gap-2 cursor-pointer mb-2">                                            <input type="checkbox" checked={hasGen2Custom} onChange={(e) => { const next = { ...(settings.gen2Lengths || {}) }; const nextR = { ...(settings.gen2Ranges || {}) }; if (e.target.checked) {
    const def: any = {};
    activePrimes.forEach((p: any) => { if (p !== limit)
        def[p] = settings.expansionC; });
    next[limit] = def;
}
else {
    delete next[limit];
    delete nextR[limit];
} handleSettingChange({ gen2Lengths: next, gen2Ranges: nextR }); }} className="w-3 h-3 accent-yellow-500"/>                                            <span className="text-[9px] font-bold text-yellow-500 uppercase">Customize Sub-Branches (Gen 2)</span>                                        </label>                                        {hasGen2Custom && (<div className="pl-2 space-y-3 border-l-2 border-yellow-900/50">                                                {activePrimes.map((g2Limit: any) => { const g2L = g2Limit as PrimeLimit; if (g2L === limit)
    return null; if (g2L === 3)
    return null; const g2Neg = settings.gen2Ranges?.[limit]?.[g2L]?.neg ?? (settings.gen2Lengths?.[limit]?.[g2L] ?? settings.expansionC); const g2Pos = settings.gen2Ranges?.[limit]?.[g2L]?.pos ?? (settings.gen2Lengths?.[limit]?.[g2L] ?? settings.expansionC); const isG2Looped = settings.axisLooping && settings.axisLooping[g2L] !== null; return (<div key={g2L} className="bg-black/30 p-2 rounded">                                                            <div className="flex justify-between items-center mb-1">                                                                <span className="text-[9px] font-bold text-yellow-200">{g2L}-Limit</span>                                                                <button onClick={() => setOpenLoopFinder(openLoopFinder?.limit === g2L && openLoopFinder.gen === 2 && openLoopFinder.parentLimit === limit ? null : { limit: g2L, gen: 2, parentLimit: limit })} className="text-[8px] bg-yellow-900/50 hover:bg-yellow-800 text-yellow-200 px-1.5 py-0.5 rounded border border-yellow-700">                                                                    Loop                                                                </button>                                                            </div>                                                            {(openLoopFinder?.limit === g2L && openLoopFinder.gen === 2 && openLoopFinder.parentLimit === limit) && (<div className="mb-2 bg-gray-900/80 p-1.5 rounded border border-yellow-700/30">                                                                    <div className="flex items-center justify-between mb-1">                                                                        <span className="text-[8px] text-gray-500">Select a loop:</span>                                                                        <label className="flex items-center gap-1 text-[8px] text-gray-500">                                                                            Order                                                                            <select value={loopOrder} onChange={(e) => setLoopOrder(e.target.value as 'size' | 'position')} className="bg-gray-900 border border-gray-700 rounded text-[8px] text-gray-200 px-1 py-0.5">                                                                                <option value="position">Position (c err)</option>                                                                                <option value="size">Size</option>                                                                            </select>                                                                        </label>                                                                    </div>                                                                    <div className="flex flex-col gap-1 max-h-[144px] overflow-y-auto custom-scrollbar pr-1">                                                                        {sortLoops(findLoops(g2L)).map((cand, idx) => (<div key={idx} className="flex justify-between items-center text-[9px]">                                                                                <span className="text-gray-400">{cand.length} ({cand.diff.toFixed(1)}c)</span>                                                                                <button onClick={() => { const neg = Math.floor(cand.length / 2); const pos = Math.ceil(cand.length / 2); const pRanges = settings.gen2Ranges?.[limit] || {}; const nextRanges = { ...settings.gen2Ranges, [limit]: { ...pRanges, [g2L]: { neg, pos } } }; handleSettingChange('gen2Ranges', nextRanges); const next = cand.length / 2; const newLooping = { ...(settings.axisLooping || {}), [limit]: next }; handleSettingChange('axisLooping', newLooping); }} className="text-[8px] bg-gray-700 px-1 rounded hover:bg-white hover:text-black">Set</button>                                                                            </div>))}                                                                    </div>                                                                </div>)}                                                            <div className="grid grid-cols-2 gap-2">                                                                <div>                                                                    <div className="flex justify-between items-center">                                                                        <span className="text-[8px] text-gray-500 uppercase">Neg</span>                                                                        <input type="number" min="0" max="20" value={g2Neg} onChange={e => { const val = Math.max(0, parseInt(e.target.value) || 0); const pRanges = settings.gen2Ranges?.[limit] || {}; const nextRanges = { ...settings.gen2Ranges, [limit]: { ...pRanges, [g2L]: { neg: val, pos: g2Pos } } }; handleSettingChange('gen2Ranges', nextRanges, false); }} className="w-8 bg-black/50 border border-gray-700 rounded text-[8px] text-yellow-500 text-center outline-none"/>                                                                    </div>                                                                    <input type="range" min="0" max="20" value={g2Neg} onPointerDown={onInteractionStart} onPointerUp={onInteractionEnd} onChange={e => { const val = parseInt(e.target.value); const pRanges = settings.gen2Ranges?.[limit] || {}; const nextRanges = { ...settings.gen2Ranges, [limit]: { ...pRanges, [g2L]: { neg: val, pos: g2Pos } } }; handleSettingChange('gen2Ranges', nextRanges, false); }} className="w-full h-1 accent-yellow-500"/>                                                                </div>                                                                <div>                                                                    <div className="flex justify-between items-center">                                                                        <span className="text-[8px] text-gray-500 uppercase">Pos</span>                                                                        <input type="number" min="0" max="20" value={g2Pos} onChange={e => { const val = Math.max(0, parseInt(e.target.value) || 0); const pRanges = settings.gen2Ranges?.[limit] || {}; const nextRanges = { ...settings.gen2Ranges, [limit]: { ...pRanges, [g2L]: { neg: g2Neg, pos: val } } }; handleSettingChange('gen2Ranges', nextRanges, false); }} className="w-8 bg-black/50 border border-gray-700 rounded text-[8px] text-yellow-500 text-center outline-none"/>                                                                    </div>                                                                    <input type="range" min="0" max="20" value={g2Pos} onPointerDown={onInteractionStart} onPointerUp={onInteractionEnd} onChange={e => { const val = parseInt(e.target.value); const pRanges = settings.gen2Ranges?.[limit] || {}; const nextRanges = { ...settings.gen2Ranges, [limit]: { ...pRanges, [g2L]: { neg: g2Neg, pos: val } } }; handleSettingChange('gen2Ranges', nextRanges, false); }} className="w-full h-1 accent-yellow-500"/>                                                                </div>                                                            </div>                                                            <div className="flex justify-between items-center mt-1">                                                                {isG2Looped ? <span className="text-[8px] text-green-400">Ring Visual Enabled</span> : <span className="text-[8px] text-gray-500">Total Length: {g2Neg + g2Pos}</span>}                                                                <button onClick={() => toggleAxisLoop(g2L)} className={`px-2 py-0.5 rounded text-[8px] border ${isLooped ? 'bg-green-900/50 border-green-500 text-green-200' : 'bg-gray-700 border-gray-600 text-gray-500 hover:bg-gray-600'}`}>{isLooped ? 'Disable Ring' : 'Enable Ring Visual'}</button>                                                            </div>                                                        </div>); })}                                        </div>)}                                </div>                            </div>); })}                </div>)}        </div>); };
